<ion-header class="ion-no-border">
  <ion-toolbar>
    <div class="header-content">
      <div class="header-left">
        <p class="header-greeting">Hola, {{ greeting }}</p>
        <h1 class="header-title">Mis tareas</h1>
      </div>
      <ion-button fill="clear" routerLink="/categories" class="categories-btn">
        <ion-icon name="pricetags-outline"></ion-icon>
      </ion-button>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- Feature Flag Firebase -->
  <div class="stats-wrapper" *ngIf="remoteConfigService.showStatistics$ | async">
    <div class="stats-card">
      <div class="stat">
        <span class="stat-number">{{ todos.length }}</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-number pending">{{ todos.length - completedCount }}</span>
        <span class="stat-label">Pendientes</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-number done">{{ completedCount }}</span>
        <span class="stat-label">Listas</span>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-wrapper">
    <div class="filters-scroll">
      <button
        class="filter-chip"
        [class.active]="selectedCategoryId === null"
        (click)="filterBy(null)">
        Todas
      </button>
      <button
        *ngFor="let cat of categories"
        class="filter-chip"
        [class.active]="selectedCategoryId === cat.id"
        (click)="filterBy(cat.id)">
        <span class="chip-dot" [style.background]="cat.color"></span>
        {{ cat.name }}
      </button>
    </div>
  </div>

  <!-- Agregar tarea -->
  <div class="add-task-wrapper">
    <div class="add-task-card">
      <ion-input
        class="task-input"
        [(ngModel)]="newTodoText"
        placeholder="Añadir nueva tarea..."
        (keyup.enter)="addTodo()">
      </ion-input>
      <div class="add-task-footer">
        <ion-select
          class="category-select"
          [(ngModel)]="selectedNewTodoCategoryId"
          placeholder="Sin categoría"
          interface="popover">
          <ion-select-option [value]="null">Sin categoría</ion-select-option>
          <ion-select-option *ngFor="let cat of categories" [value]="cat.id">
            {{ cat.name }}
          </ion-select-option>
        </ion-select>
        <button class="add-btn" (click)="addTodo()" [disabled]="!newTodoText.trim()">
          <ion-icon name="add"></ion-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Lista con Virtual Scroll para manejo eficiente de grandes cantidades de tareas -->
  <div class="tasks-wrapper">
    <p class="tasks-count" *ngIf="filteredTodos.length > 0">
      {{ filteredTodos.length }} tarea{{ filteredTodos.length !== 1 ? 's' : '' }}
    </p>

    <cdk-virtual-scroll-viewport itemSize="72" class="virtual-scroll">
      <ion-item-sliding *cdkVirtualFor="let todo of filteredTodos; trackBy: trackById">
        <ion-item class="task-item" lines="none">
          <div class="task-check" slot="start">
            <button
              class="check-btn"
              [class.checked]="todo.completed"
              (click)="toggleTodo(todo)">
              <ion-icon name="checkmark" *ngIf="todo.completed"></ion-icon>
            </button>
          </div>
          <div class="task-content">
            <p class="task-text" [class.done]="todo.completed">{{ todo.text }}</p>
            <div class="task-category" *ngIf="getCategoryById(todo.categoryId) as cat">
              <span class="cat-dot" [style.background]="cat.color"></span>
              <span class="cat-name">{{ cat.name }}</span>
            </div>
          </div>
        </ion-item>
        <ion-item-options side="end">
          <ion-item-option color="danger" (click)="deleteTodo(todo)">
            <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </cdk-virtual-scroll-viewport>

    <!-- Empty state -->
    <div class="empty-state" *ngIf="filteredTodos.length === 0">
      <div class="empty-icon">✓</div>
      <p class="empty-title">Todo al día</p>
      <p class="empty-subtitle">No hay tareas en esta categoría</p>
    </div>
  </div>

  <!-- Swipe hint - aparece solo la primera vez -->
  <div class="swipe-hint" *ngIf="showSwipeHint" (click)="dismissHint()">
    <div class="hint-card">
      <div class="hint-animation">
        <div class="hint-task-preview">
          <div class="hint-check"></div>
          <div class="hint-lines">
            <div class="hint-line long"></div>
            <div class="hint-line short"></div>
          </div>
        </div>
        <div class="swipe-arrow">
          <ion-icon name="arrow-back-outline"></ion-icon>
          <ion-icon name="arrow-back-outline"></ion-icon>
          <ion-icon name="arrow-back-outline"></ion-icon>
        </div>
        <div class="hint-delete-preview">
          <ion-icon name="trash-outline"></ion-icon>
        </div>
      </div>
      <p class="hint-text">Desliza hacia la izquierda para eliminar una tarea</p>
      <span class="hint-dismiss">Toca para cerrar</span>
    </div>
  </div>

</ion-content>